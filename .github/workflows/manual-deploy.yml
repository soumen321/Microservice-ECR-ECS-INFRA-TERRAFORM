name: Manual Deploy Specific Tag

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        default: 'latest'
      task_definition_family:
        description: 'Task definition family name'
        required: true
        default: 'myapp-poc'

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_NAME }}
  ECS_CLUSTER: ${{ secrets.ECS_CLUSTER_NAME }}
  ECS_SERVICE: ${{ secrets.ECS_SERVICE_NAME }}

jobs:
  deploy-tag:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy specific tag to ECS
        env:
          IMAGE_TAG: ${{ github.event.inputs.image_tag }}
          TASK_DEF_FAMILY: ${{ github.event.inputs.task_definition_family }}
        run: |
          # Get ECR registry URL
          ECR_REGISTRY=$(aws ecr describe-repositories \
            --repository-names $ECR_REPOSITORY \
            --query 'repositories[0].repositoryUri' \
            --output text | cut -d'/' -f1)
          
          IMAGE="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "üöÄ Deploying image: $IMAGE"
          echo "üìù Task definition family: $TASK_DEF_FAMILY"

          # Download current task definition
          echo "üì• Downloading current task definition..."
          aws ecs describe-task-definition \
            --task-definition "$TASK_DEF_FAMILY" \
            --query taskDefinition \
            > task-definition.json
          
          # Update image in task definition
          echo "üîÑ Updating image in task definition..."
          jq ".containerDefinitions[0].image = \"$IMAGE\"" task-definition.json > updated-task-definition.json
          
          # ‚≠ê FIX: Remove invalid fields before registering ‚≠ê
          echo "üßπ Cleaning task definition (removing invalid fields)..."
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
            updated-task-definition.json > clean-task-definition.json
          
          # Register new task definition
          echo "üìù Registering new task definition..."
          aws ecs register-task-definition \
            --cli-input-json file://clean-task-definition.json
          
          # Get the latest revision number
          echo "üîç Getting latest revision..."
          LATEST_REVISION=$(aws ecs describe-task-definition \
            --task-definition "$TASK_DEF_FAMILY" \
            --query 'taskDefinition.revision' \
            --output text)
          
          echo "‚úÖ New revision: $LATEST_REVISION"
          
          # Update ECS service
          echo "‚öôÔ∏è Updating ECS service..."
          aws ecs update-service \
            --cluster "$ECS_CLUSTER" \
            --service "$ECS_SERVICE" \
            --task-definition "$TASK_DEF_FAMILY:$LATEST_REVISION"
          
          echo "üéâ Deployment initiated successfully!"
          
          # Show deployment status
          echo "üìä Checking deployment status..."
          aws ecs describe-services \
            --cluster "$ECS_CLUSTER" \
            --services "$ECS_SERVICE" \
            --query 'services[0].deployments[0]'